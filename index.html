<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Valentine 3D Love Letter</title>
  <style>
    /* ===========================
       GLOBAL + THEME
    =========================== */
    :root {
      --bg-dark: #060204;
      --bg-deep-red: #1f0208;
      --bg-wine: #450014;
      --accent: #ff3f73;
      --accent-soft: #ff8cab;
      --accent-gold: #ffd7b3;
      --glow-strong: 0 0 18px rgba(255, 74, 122, 0.95), 0 0 40px rgba(255, 74, 122, 0.5);
      --text-main: #fff4f7;
      --envelope: #ffe5ee;
      --envelope-dark: #f4bfd0;
      --letter: #fffafc;
      --ink: #6b1232;
    }

    * {
      box-sizing: border-box;
      -webkit-tap-highlight-color: transparent;
    }

    html,
    body {
      width: 100%;
      height: 100%;
      margin: 0;
      overflow: hidden;
      font-family: "Trebuchet MS", "Segoe UI", sans-serif;
      color: var(--text-main);
      background: radial-gradient(circle at 25% 20%, #5a001b 0%, transparent 40%),
                  radial-gradient(circle at 75% 80%, #3a0012 0%, transparent 45%),
                  linear-gradient(135deg, var(--bg-deep-red) 0%, var(--bg-dark) 55%, #000 100%);
      perspective: 1200px;
    }

    .scene {
      position: relative;
      width: 100%;
      height: 100%;
      isolation: isolate;
      overflow: hidden;
      transform-origin: center;
      will-change: transform;
    }

    .vignette {
      position: absolute;
      inset: 0;
      pointer-events: none;
      background: radial-gradient(circle at center, transparent 50%, rgba(0, 0, 0, 0.6) 100%);
      z-index: 8;
    }

    .hud {
      position: absolute;
      left: 14px;
      top: 14px;
      z-index: 20;
      display: flex;
      gap: 8px;
      align-items: center;
    }

    .control-btn {
      border: 1px solid rgba(255, 200, 220, 0.42);
      background: linear-gradient(160deg, rgba(255, 83, 139, 0.35), rgba(80, 0, 26, 0.45));
      color: #fff4f7;
      font-size: 0.76rem;
      letter-spacing: 0.3px;
      padding: 8px 10px;
      border-radius: 999px;
      cursor: pointer;
      backdrop-filter: blur(6px);
      box-shadow: 0 0 14px rgba(255, 95, 150, 0.25);
    }

    .control-btn:hover {
      box-shadow: 0 0 18px rgba(255, 95, 150, 0.45);
    }

    /* ===========================
       PARTICLE CANVAS
    =========================== */
    #sparkleCanvas {
      position: absolute;
      inset: 0;
      width: 100%;
      height: 100%;
      z-index: 1;
      pointer-events: none;
    }

    /* ===========================
       FLOATING HEARTS LAYER
    =========================== */
    .heart-field {
      position: absolute;
      inset: 0;
      z-index: 3;
      transform-style: preserve-3d;
      transition: filter 700ms ease, opacity 700ms ease;
    }

    .heart-field.dimmed {
      filter: blur(2px) brightness(0.55);
      opacity: 0.45;
    }

    .heart-3d {
      position: absolute;
      width: var(--size);
      height: var(--size);
      transform-style: preserve-3d;
      transform: translate3d(var(--x), var(--y), var(--z)) rotateX(var(--rx)) rotateY(var(--ry));
      animation:
        heart-float var(--floatDur) ease-in-out infinite,
        heart-spin var(--spinDur) linear infinite;
      cursor: pointer;
      filter: drop-shadow(0 10px 20px rgba(0, 0, 0, 0.45));
      will-change: transform;
    }

    .heart-3d .shape {
      position: absolute;
      inset: 0;
      transform: rotate(45deg);
      background: linear-gradient(145deg, #ff9db7 0%, #ff437c 45%, #ba0f42 100%);
      border-radius: 18% 0 10% 15%;
      box-shadow:
        inset -10px -10px 16px rgba(95, 0, 28, 0.45),
        inset 8px 10px 14px rgba(255, 195, 214, 0.42),
        0 0 20px rgba(255, 66, 122, 0.65);
    }

    .heart-3d .shape::before,
    .heart-3d .shape::after {
      content: "";
      position: absolute;
      width: 100%;
      height: 100%;
      border-radius: 50%;
      background: inherit;
      box-shadow: inherit;
    }

    .heart-3d .shape::before {
      top: -52%;
      left: 0;
    }

    .heart-3d .shape::after {
      top: 0;
      left: -52%;
    }

    /* Fake thickness / depth layer */
    .heart-3d .depth {
      position: absolute;
      inset: 0;
      transform: rotate(45deg) translateZ(-8px);
      background: linear-gradient(145deg, #8a082f, #500017);
      opacity: 0.85;
      filter: blur(1px);
      border-radius: 18% 0 10% 15%;
    }

    .heart-3d .depth::before,
    .heart-3d .depth::after {
      content: "";
      position: absolute;
      width: 100%;
      height: 100%;
      border-radius: 50%;
      background: inherit;
    }

    .heart-3d .depth::before {
      top: -52%;
      left: 0;
    }

    .heart-3d .depth::after {
      top: 0;
      left: -52%;
    }

    .heart-3d .shine {
      position: absolute;
      width: 36%;
      height: 36%;
      border-radius: 999px;
      top: 12%;
      left: 58%;
      transform: translateX(-50%) rotate(20deg);
      background: radial-gradient(circle at 30% 30%, rgba(255, 255, 255, 0.9), rgba(255, 255, 255, 0));
      filter: blur(1px);
      pointer-events: none;
    }

    .heart-3d::after {
      content: "";
      position: absolute;
      inset: -22%;
      border-radius: 50%;
      background: radial-gradient(circle, rgba(255, 71, 126, 0.55) 0%, rgba(255, 71, 126, 0) 72%);
      filter: blur(6px);
      z-index: -1;
      pointer-events: none;
      animation: pulse 2.8s ease-in-out infinite;
    }

    .heart-3d.selected {
      animation: none;
      z-index: 50;
      transition: transform 900ms cubic-bezier(0.2, 0.8, 0.2, 1), filter 700ms ease;
      transform: translate3d(calc(50vw - 50%), calc(38vh - 50%), 170px) scale(2.6) rotateX(-12deg) rotateY(10deg);
      filter: drop-shadow(0 20px 30px rgba(0, 0, 0, 0.4)) drop-shadow(0 0 26px rgba(255, 82, 135, 0.8));
    }

    /* ===========================
       LETTER EXPERIENCE
    =========================== */
    .letter-stage {
      position: absolute;
      left: 50%;
      top: 70%;
      width: min(88vw, 440px);
      transform: translate(-50%, -50%) scale(0.82);
      transform-origin: center;
      opacity: 0;
      z-index: 12;
      pointer-events: none;
      transition: opacity 650ms ease, transform 900ms cubic-bezier(0.2, 0.7, 0.2, 1);
    }

    .letter-stage.visible {
      opacity: 1;
      transform: translate(-50%, -50%) scale(1);
      pointer-events: auto;
    }

    .envelope-wrap {
      position: relative;
      width: 100%;
      height: clamp(220px, 35vw, 280px);
      perspective: 1100px;
      filter: drop-shadow(0 18px 28px rgba(0, 0, 0, 0.5));
    }

    .envelope {
      position: absolute;
      inset: 0;
      background: linear-gradient(145deg, var(--envelope) 0%, var(--envelope-dark) 100%);
      border-radius: 12px;
      overflow: hidden;
      cursor: pointer;
      transform-style: preserve-3d;
      border: 1px solid rgba(255, 255, 255, 0.35);
    }

    .envelope::before {
      content: "";
      position: absolute;
      inset: 0;
      background: linear-gradient(45deg, rgba(255, 255, 255, 0.35), rgba(255, 255, 255, 0));
      pointer-events: none;
    }

    .envelope-base {
      position: absolute;
      inset: 0;
      clip-path: polygon(0 0, 50% 52%, 100% 0, 100% 100%, 0 100%);
      background: linear-gradient(160deg, #ffd8e5, #f5b5c8);
      z-index: 2;
    }

    .envelope-flap {
      position: absolute;
      left: 0;
      top: 0;
      width: 100%;
      height: 60%;
      transform-origin: top;
      transform-style: preserve-3d;
      clip-path: polygon(0 0, 100% 0, 50% 100%);
      background: linear-gradient(170deg, #fff1f6, #f6b9cf);
      z-index: 5;
      transition: transform 1100ms cubic-bezier(0.2, 0.8, 0.2, 1), filter 700ms ease;
      box-shadow: inset 0 -8px 20px rgba(173, 58, 99, 0.25);
    }

    .envelope.open .envelope-flap {
      transform: rotateX(-170deg) translateY(-2px);
      filter: brightness(1.1);
    }

    .wax-seal {
      position: absolute;
      left: 50%;
      top: 52%;
      transform: translate(-50%, -50%);
      width: 54px;
      height: 54px;
      border-radius: 50%;
      background: radial-gradient(circle at 30% 25%, #ff6d98, #cf1d57 65%, #9d0037 100%);
      box-shadow: 0 0 18px rgba(255, 74, 122, 0.5), inset 0 -4px 8px rgba(83, 0, 28, 0.45);
      z-index: 7;
      display: grid;
      place-items: center;
      color: #fff;
      font-size: 20px;
      text-shadow: var(--glow-strong);
      transition: opacity 400ms ease;
    }

    .envelope.open .wax-seal {
      opacity: 0;
    }

    .letter-paper {
      position: absolute;
      left: 50%;
      bottom: 22px;
      width: 90%;
      min-height: 72%;
      transform: translateX(-50%) translateY(78%) scale(0.92);
      border-radius: 12px;
      padding: clamp(16px, 3.8vw, 22px);
      background: linear-gradient(170deg, var(--letter), #ffeef5 85%);
      color: var(--ink);
      z-index: 4;
      box-shadow: 0 10px 25px rgba(130, 10, 52, 0.22);
      transition: transform 1200ms cubic-bezier(0.2, 0.8, 0.2, 1);
      overflow: hidden;
    }

    .envelope.open .letter-paper {
      transform: translateX(-50%) translateY(-28%) scale(1);
    }

    .letter-paper::before {
      content: "";
      position: absolute;
      inset: 0;
      background: repeating-linear-gradient(
        180deg,
        rgba(255, 205, 224, 0.12) 0,
        rgba(255, 205, 224, 0.12) 2px,
        transparent 2px,
        transparent 30px
      );
      pointer-events: none;
    }

    .letter-content {
      position: relative;
      opacity: 0;
      transform: translateY(14px);
      transition: opacity 800ms ease 320ms, transform 900ms ease 320ms;
      text-align: center;
    }

    .envelope.open .letter-content {
      opacity: 1;
      transform: translateY(0);
    }

    .letter-title {
      margin: 0 0 10px;
      font-size: clamp(1.2rem, 4vw, 1.8rem);
      color: #d81f59;
      text-shadow: 0 0 12px rgba(255, 74, 122, 0.65);
      letter-spacing: 0.3px;
      font-weight: 700;
    }

    .letter-text {
      margin: 0;
      line-height: 1.7;
      font-size: clamp(0.95rem, 3.3vw, 1.1rem);
      color: #7c1a3d;
      text-shadow: 0 0 10px rgba(255, 167, 194, 0.45);
      white-space: pre-line;
    }

    .hint {
      position: absolute;
      bottom: -34px;
      left: 50%;
      transform: translateX(-50%);
      font-size: 0.82rem;
      letter-spacing: 0.5px;
      opacity: 0.75;
      color: #ffdce8;
      text-shadow: 0 0 8px rgba(255, 92, 139, 0.5);
      pointer-events: none;
    }

    .mini-heart {
      position: absolute;
      width: 12px;
      height: 12px;
      transform: rotate(45deg);
      background: #ff5d90;
      border-radius: 2px;
      pointer-events: none;
      opacity: 0;
      box-shadow: 0 0 12px rgba(255, 95, 150, 0.9);
      animation: mini-burst 1900ms ease-out forwards;
      z-index: 15;
    }

    .mini-heart::before,
    .mini-heart::after {
      content: "";
      position: absolute;
      width: 12px;
      height: 12px;
      border-radius: 50%;
      background: inherit;
    }

    .mini-heart::before {
      top: -6px;
      left: 0;
    }

    .mini-heart::after {
      top: 0;
      left: -6px;
    }

    /* ===========================
       ANIMATIONS
    =========================== */
    @keyframes heart-float {
      0%,
      100% {
        transform: translate3d(var(--x), calc(var(--y) + 0px), var(--z)) rotateX(var(--rx)) rotateY(var(--ry)) scale(1);
      }
      50% {
        transform: translate3d(var(--x), calc(var(--y) - 16px), calc(var(--z) + 26px)) rotateX(calc(var(--rx) + 6deg)) rotateY(calc(var(--ry) - 9deg)) scale(1.03);
      }
    }

    @keyframes heart-spin {
      from {
        rotate: 0deg;
      }
      to {
        rotate: 360deg;
      }
    }

    @keyframes pulse {
      0%,
      100% {
        opacity: 0.45;
      }
      50% {
        opacity: 0.92;
      }
    }

    @keyframes mini-burst {
      0% {
        opacity: 0;
        transform: translate3d(0, 0, 0) scale(0.2) rotate(45deg);
      }
      15% {
        opacity: 1;
      }
      100% {
        opacity: 0;
        transform: translate3d(var(--tx), var(--ty), 0) scale(1.2) rotate(45deg);
      }
    }

    /* ===========================
       RESPONSIVE TUNING
    =========================== */
    @media (max-width: 768px) {
      .heart-3d.selected {
        transform: translate3d(calc(50vw - 50%), calc(34vh - 50%), 110px) scale(2.15) rotateX(-10deg) rotateY(8deg);
      }

      .letter-stage {
        top: 72%;
      }

      .hint {
        bottom: -30px;
        font-size: 0.76rem;
      }
    }

    @media (max-width: 420px) {
      .letter-stage {
        width: 92vw;
      }

      .envelope-wrap {
        height: 240px;
      }

      .wax-seal {
        width: 46px;
        height: 46px;
        font-size: 16px;
      }
    }
  </style>
</head>
<body>
  <main class="scene" id="scene">
    <!-- Minimal control HUD -->
    <div class="hud">
      <button class="control-btn" id="musicToggle" type="button" aria-pressed="false">♪ Bật nhạc</button>
    </div>

    <!-- Sparkle particles -->
    <canvas id="sparkleCanvas" aria-hidden="true"></canvas>

    <!-- Floating 3D hearts container -->
    <section class="heart-field" id="heartField" aria-label="Valentine floating hearts"></section>

    <!-- Envelope + letter reveal -->
    <section class="letter-stage" id="letterStage" aria-live="polite">
      <div class="envelope-wrap">
        <article class="envelope" id="envelope" role="button" tabindex="0" aria-label="Open love letter envelope">
          <div class="envelope-flap"></div>
          <div class="envelope-base"></div>
          <div class="wax-seal">❤</div>

          <div class="letter-paper">
            <div class="letter-content">
              <h1 class="letter-title">Happy Valentine's Day ❤️</h1>
              <p class="letter-text">Chúc mừng em Valentine thật xinh đẹp,
Luôn rạng rỡ như những đóa hoa mùa xuân,❤️</p>
            </div>
          </div>
        </article>
        <p class="hint" id="hintText">Chạm vào phong bì để mở thư</p>
      </div>
    </section>

    <div class="vignette"></div>
  </main>

  <!-- Optional: replace src with your own mp3 file for deployment -->
  <audio id="bgm" loop preload="auto">
    <source src="music.mp3" type="audio/mpeg" />
  </audio>

  <script>
    // ===========================
    // CONFIG
    // ===========================
    const HEART_COUNT = Math.min(18, window.innerWidth < 600 ? 11 : 16);
    const sparkleCanvas = document.getElementById("sparkleCanvas");
    const scene = document.getElementById("scene");
    const heartField = document.getElementById("heartField");
    const letterStage = document.getElementById("letterStage");
    const envelope = document.getElementById("envelope");
    const hintText = document.getElementById("hintText");
    const musicToggle = document.getElementById("musicToggle");
    const bgm = document.getElementById("bgm");

    let selectedHeart = null;
    let letterOpened = false;
    let musicPlaying = false;
    let cameraStart = performance.now();
    let pointerX = 0;
    let pointerY = 0;

    // ===========================
    // PARTICLE SYSTEM (lightweight canvas for 60fps)
    // ===========================
    const ctx = sparkleCanvas.getContext("2d", { alpha: true });
    let dpr = Math.min(window.devicePixelRatio || 1, 2);
    let particles = [];

    function resizeCanvas() {
      const w = window.innerWidth;
      const h = window.innerHeight;
      dpr = Math.min(window.devicePixelRatio || 1, 2);
      sparkleCanvas.width = Math.floor(w * dpr);
      sparkleCanvas.height = Math.floor(h * dpr);
      sparkleCanvas.style.width = w + "px";
      sparkleCanvas.style.height = h + "px";
      ctx.setTransform(dpr, 0, 0, dpr, 0, 0);

      particles = Array.from({ length: window.innerWidth < 768 ? 46 : 72 }, () => createParticle(w, h));
    }

    function createParticle(w, h) {
      return {
        x: Math.random() * w,
        y: Math.random() * h,
        r: Math.random() * 1.9 + 0.4,
        a: Math.random() * Math.PI * 2,
        speed: Math.random() * 0.18 + 0.06,
        drift: (Math.random() - 0.5) * 0.18,
        alpha: Math.random() * 0.45 + 0.2
      };
    }

    function drawParticles() {
      const w = window.innerWidth;
      const h = window.innerHeight;
      ctx.clearRect(0, 0, w, h);

      for (const p of particles) {
        p.a += 0.016;
        p.y -= p.speed;
        p.x += Math.sin(p.a) * p.drift;

        if (p.y < -8) {
          p.y = h + 8;
          p.x = Math.random() * w;
        }

        const twinkle = 0.55 + Math.sin(p.a * 1.9) * 0.45;
        ctx.beginPath();
        ctx.arc(p.x, p.y, p.r, 0, Math.PI * 2);
        ctx.fillStyle = `rgba(255, ${190 + Math.floor(twinkle * 50)}, ${215 + Math.floor(twinkle * 30)}, ${p.alpha})`;
        ctx.shadowColor = "rgba(255,120,160,0.55)";
        ctx.shadowBlur = 12;
        ctx.fill();
      }
      requestAnimationFrame(drawParticles);
    }

    // ===========================
    // CAMERA PAN (cinematic drift)
    // ===========================
    function updateCamera() {
      const t = (performance.now() - cameraStart) * 0.0002;
      const autoX = Math.sin(t) * 10;
      const autoY = Math.cos(t * 1.18) * 6;
      const mixX = autoX + pointerX * 6;
      const mixY = autoY + pointerY * 4;
      scene.style.transform = `translate3d(${mixX}px, ${mixY}px, 0) scale(1.02)`;
      requestAnimationFrame(updateCamera);
    }

    function onPointerMove(clientX, clientY) {
      const nx = (clientX / window.innerWidth) * 2 - 1;
      const ny = (clientY / window.innerHeight) * 2 - 1;
      pointerX = nx * 0.45;
      pointerY = ny * 0.45;
    }

    // ===========================
    // HEART FACTORY
    // ===========================
    function createHeart(index) {
      const heart = document.createElement("button");
      heart.className = "heart-3d";
      heart.type = "button";
      heart.setAttribute("aria-label", `Heart ${index + 1}`);

      const size = Math.random() * 38 + 34;
      const x = `${Math.random() * 86 + 4}vw`;
      const y = `${Math.random() * 70 + 8}vh`;
      const z = `${Math.random() * 140 - 70}px`;
      const rx = `${Math.random() * 24 - 12}deg`;
      const ry = `${Math.random() * 28 - 14}deg`;
      const floatDur = `${Math.random() * 2.8 + 3.8}s`;
      const spinDur = `${Math.random() * 7 + 8}s`;

      heart.style.setProperty("--size", `${size}px`);
      heart.style.setProperty("--x", x);
      heart.style.setProperty("--y", y);
      heart.style.setProperty("--z", z);
      heart.style.setProperty("--rx", rx);
      heart.style.setProperty("--ry", ry);
      heart.style.setProperty("--floatDur", floatDur);
      heart.style.setProperty("--spinDur", spinDur);

      heart.innerHTML = `
        <span class="depth"></span>
        <span class="shape"></span>
        <span class="shine"></span>
      `;

      heart.addEventListener("click", () => focusHeart(heart));
      return heart;
    }

    function spawnHearts() {
      const fragment = document.createDocumentFragment();
      for (let i = 0; i < HEART_COUNT; i += 1) {
        fragment.appendChild(createHeart(i));
      }
      heartField.appendChild(fragment);
    }

    function focusHeart(heart) {
      if (selectedHeart) return;
      selectedHeart = heart;

      const hearts = [...heartField.querySelectorAll(".heart-3d")];
      hearts.forEach((h) => {
        if (h !== heart) {
          h.style.opacity = "0.18";
          h.style.pointerEvents = "none";
        }
      });

      heart.classList.add("selected");
      heartField.classList.add("dimmed");

      setTimeout(() => {
        letterStage.classList.add("visible");
      }, 760);
    }

    // ===========================
    // ENVELOPE OPEN + MINI HEART BURST
    // ===========================
    function openEnvelope() {
      if (letterOpened || !selectedHeart) return;
      letterOpened = true;
      envelope.classList.add("open");
      hintText.textContent = "Mãi yêu em ❤️";
      createMiniHeartBurst();
      setTimeout(createMiniHeartBurst, 350);
      tryPlayMusic();
    }

    function createMiniHeartBurst() {
      const rect = envelope.getBoundingClientRect();
      const count = 12;

      for (let i = 0; i < count; i += 1) {
        const mini = document.createElement("span");
        mini.className = "mini-heart";

        const sx = rect.left + rect.width * (0.42 + Math.random() * 0.16);
        const sy = rect.top + rect.height * 0.28;
        const tx = (Math.random() - 0.5) * 160;
        const ty = -(Math.random() * 140 + 40);

        mini.style.left = `${sx}px`;
        mini.style.top = `${sy}px`;
        mini.style.setProperty("--tx", `${tx}px`);
        mini.style.setProperty("--ty", `${ty}px`);
        mini.style.animationDelay = `${Math.random() * 0.16}s`;

        document.body.appendChild(mini);
        setTimeout(() => mini.remove(), 2200);
      }
    }

    envelope.addEventListener("click", openEnvelope);
    envelope.addEventListener("keydown", (event) => {
      if (event.key === "Enter" || event.key === " ") {
        event.preventDefault();
        openEnvelope();
      }
    });

    // ===========================
    // MUSIC TOGGLE
    // ===========================
    async function tryPlayMusic() {
      if (!bgm) return;
      try {
        bgm.volume = 0.55;
        await bgm.play();
        musicPlaying = true;
        musicToggle.setAttribute("aria-pressed", "true");
        musicToggle.textContent = "♫ Tắt nhạc";
      } catch (_err) {
        musicPlaying = false;
        musicToggle.setAttribute("aria-pressed", "false");
        musicToggle.textContent = "♪ Bật nhạc";
      }
    }

    function stopMusic() {
      if (!bgm) return;
      bgm.pause();
      bgm.currentTime = 0;
      musicPlaying = false;
      musicToggle.setAttribute("aria-pressed", "false");
      musicToggle.textContent = "♪ Bật nhạc";
    }

    musicToggle.addEventListener("click", async () => {
      if (!musicPlaying) {
        await tryPlayMusic();
      } else {
        stopMusic();
      }
    });

    window.addEventListener("mousemove", (e) => onPointerMove(e.clientX, e.clientY), { passive: true });
    window.addEventListener("touchmove", (e) => {
      const t = e.touches[0];
      if (!t) return;
      onPointerMove(t.clientX, t.clientY);
    }, { passive: true });

    // ===========================
    // INIT
    // ===========================
    window.addEventListener("resize", resizeCanvas);
    resizeCanvas();
    drawParticles();
    updateCamera();
    spawnHearts();
  </script>
</body>
</html>

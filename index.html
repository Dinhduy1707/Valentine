<!doctype html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Valentine Cinematic Reveal</title>
    <style>
      /* ===============================
       Theme + Base
    =============================== */
      :root {
        --bg-1: #060205;
        --bg-2: #1a0008;
        --bg-3: #320012;
        --pink: #ff4f87;
        --pink-soft: #ff9abb;
        --gold: #ffd4b8;
        --ink: #7f2146;
        --letter: #fff9fc;
        --env-1: #ffe8f1;
        --env-2: #f7c4d7;
        --glow:
          0 0 14px rgba(255, 78, 133, 0.85), 0 0 30px rgba(255, 78, 133, 0.5);
      }

      * {
        box-sizing: border-box;
        -webkit-tap-highlight-color: transparent;
      }

      html,
      body {
        width: 100%;
        height: 100%;
        margin: 0;
        overflow: hidden;
        font-family: "Trebuchet MS", "Segoe UI", sans-serif;
        background:
          radial-gradient(
            circle at 16% 18%,
            rgba(129, 0, 39, 0.38),
            transparent 44%
          ),
          radial-gradient(
            circle at 82% 72%,
            rgba(144, 0, 53, 0.28),
            transparent 48%
          ),
          linear-gradient(140deg, var(--bg-2) 0%, var(--bg-1) 52%, #000 100%);
        color: #fff7fb;
        perspective: 1200px;
      }

      .scene {
        position: relative;
        width: 100%;
        height: 100%;
        overflow: hidden;
        isolation: isolate;
        transform-origin: center;
        will-change: transform;
      }

      .grain,
      .vignette,
      .flash {
        position: absolute;
        inset: 0;
        pointer-events: none;
      }

      .grain {
        z-index: 2;
        opacity: 0.08;
        background-image:
          radial-gradient(
            circle at 20% 30%,
            rgba(255, 255, 255, 0.8) 0.8px,
            transparent 1px
          ),
          radial-gradient(
            circle at 70% 60%,
            rgba(255, 255, 255, 0.8) 0.8px,
            transparent 1px
          );
        background-size:
          5px 5px,
          6px 6px;
        mix-blend-mode: soft-light;
        animation: grainShift 3.8s steps(7) infinite;
      }

      .vignette {
        z-index: 10;
        background: radial-gradient(
          circle at center,
          transparent 50%,
          rgba(0, 0, 0, 0.68) 100%
        );
      }

      .flash {
        z-index: 13;
        opacity: 0;
        background: radial-gradient(
          circle at center,
          rgba(255, 135, 178, 0.9) 0%,
          rgba(255, 135, 178, 0) 58%
        );
        transition: opacity 420ms ease;
      }

      .flash.active {
        opacity: 1;
      }

      /* ===============================
       HUD + Hint
    =============================== */
      .hud {
        position: absolute;
        left: 14px;
        top: 14px;
        z-index: 20;
        display: flex;
        gap: 8px;
      }

      .control-btn {
        border: 1px solid rgba(255, 202, 220, 0.4);
        background: linear-gradient(
          165deg,
          rgba(255, 78, 134, 0.35),
          rgba(84, 0, 26, 0.45)
        );
        color: #fff4f8;
        font-size: 0.75rem;
        letter-spacing: 0.3px;
        padding: 8px 11px;
        border-radius: 999px;
        cursor: pointer;
        backdrop-filter: blur(6px);
        box-shadow: 0 0 16px rgba(255, 94, 150, 0.25);
      }

      .intro {
        position: absolute;
        left: 50%;
        top: 18%;
        transform: translateX(-50%);
        z-index: 14;
        text-align: center;
        opacity: 1;
        transition: opacity 500ms ease;
        pointer-events: none;
      }

      .intro.hide {
        opacity: 0;
      }

      .intro h1 {
        margin: 0;
        font-size: clamp(1.2rem, 4vw, 1.9rem);
        letter-spacing: 0.6px;
        color: #ffdce8;
        text-shadow: var(--glow);
      }

      .intro p {
        margin: 8px 0 0;
        font-size: clamp(0.8rem, 2.8vw, 1rem);
        color: #ffbfd6;
        opacity: 0.9;
      }

      /* ===============================
       Canvas FX
    =============================== */
      #fxCanvas {
        position: absolute;
        inset: 0;
        width: 100%;
        height: 100%;
        z-index: 1;
        pointer-events: none;
      }

      /* ===============================
       Floating Hearts
    =============================== */
      .heart-field {
        position: absolute;
        inset: 0;
        z-index: 5;
        transform-style: preserve-3d;
        transition:
          filter 700ms ease,
          opacity 700ms ease;
      }

      .heart-field.dimmed {
        filter: blur(2px) brightness(0.54);
        opacity: 0.45;
      }

      .heart-3d {
        position: absolute;
        border: none;
        background: transparent;
        padding: 0;
        width: var(--size);
        height: var(--size);
        transform-style: preserve-3d;
        transform: translate3d(0, 0, 0);
        cursor: pointer;
        will-change: transform;
        filter: drop-shadow(0 12px 18px rgba(0, 0, 0, 0.4));
      }

      .heart-3d .shape {
        position: absolute;
        inset: 0;
        transform: rotate(45deg);
        border-radius: 18% 0 12% 14%;
        background: linear-gradient(
          150deg,
          var(--c1),
          var(--c2) 46%,
          var(--c3)
        );
        box-shadow:
          inset -10px -10px 14px rgba(94, 0, 28, 0.44),
          inset 9px 12px 15px rgba(255, 212, 227, 0.54),
          0 0 22px color-mix(in srgb, var(--c2) 76%, transparent);
      }

      .heart-3d .shape::before,
      .heart-3d .shape::after,
      .heart-3d .depth::before,
      .heart-3d .depth::after {
        content: "";
        position: absolute;
        width: 100%;
        height: 100%;
        border-radius: 50%;
        background: inherit;
      }

      .heart-3d .shape::before,
      .heart-3d .depth::before {
        top: -52%;
        left: 0;
      }

      .heart-3d .shape::after,
      .heart-3d .depth::after {
        top: 0;
        left: -52%;
      }

      .heart-3d .depth {
        position: absolute;
        inset: 0;
        transform: rotate(45deg) translateZ(-8px);
        border-radius: 18% 0 12% 14%;
        background: linear-gradient(
          145deg,
          color-mix(in srgb, var(--c3) 75%, #32000f),
          #32000f
        );
        opacity: 0.82;
        filter: blur(1px);
      }

      .heart-3d .shine {
        position: absolute;
        width: 35%;
        height: 35%;
        top: 12%;
        left: 58%;
        transform: translateX(-50%) rotate(20deg);
        border-radius: 999px;
        background: radial-gradient(
          circle at 30% 30%,
          rgba(255, 255, 255, 0.96),
          rgba(255, 255, 255, 0)
        );
        filter: blur(0.8px);
      }

      .heart-3d::after {
        content: "";
        position: absolute;
        inset: -24%;
        border-radius: 50%;
        background: radial-gradient(
          circle,
          color-mix(in srgb, var(--c2) 70%, white 8%),
          rgba(255, 91, 144, 0) 72%
        );
        filter: blur(6px);
        z-index: -1;
        animation: pulse 2.6s ease-in-out infinite;
      }

      .heart-3d.outline .depth,
      .heart-3d.outline .shine {
        display: none;
      }

      .heart-3d.outline .shape,
      .heart-3d.outline .shape::before,
      .heart-3d.outline .shape::after {
        background: transparent;
        border: 2.5px solid var(--outline);
        box-shadow:
          inset 0 0 9px color-mix(in srgb, var(--outline) 58%, white),
          0 0 14px color-mix(in srgb, var(--outline) 76%, transparent);
      }

      .heart-3d.outline::after {
        background: radial-gradient(
          circle,
          color-mix(in srgb, var(--outline) 50%, white),
          rgba(255, 149, 193, 0) 72%
        );
      }

      .heart-3d.selected {
        z-index: 50;
        transition:
          transform 900ms cubic-bezier(0.2, 0.8, 0.2, 1),
          filter 700ms ease;
        transform: translate3d(calc(50vw - 50%), calc(38vh - 50%), 170px)
          scale(2.6) rotateX(-14deg) rotateY(12deg);
        filter: drop-shadow(0 0 28px rgba(255, 94, 151, 0.95));
      }

      /* ===============================
       Envelope + Letter
    =============================== */
      .letter-stage {
        position: absolute;
        left: 50%;
        top: 72%;
        width: min(90vw, 460px);
        transform: translate(-50%, -50%) scale(0.8);
        transform-origin: center;
        opacity: 0;
        z-index: 15;
        pointer-events: none;
        transition:
          opacity 520ms ease,
          transform 900ms cubic-bezier(0.2, 0.8, 0.2, 1);
      }

      .letter-stage.visible {
        opacity: 1;
        transform: translate(-50%, -50%) scale(1);
        pointer-events: auto;
        animation: stagePop 900ms cubic-bezier(0.2, 0.8, 0.2, 1) both;
      }

      .envelope-wrap {
        position: relative;
        width: 100%;
        height: clamp(220px, 35vw, 292px);
        perspective: 1100px;
        filter: drop-shadow(0 20px 30px rgba(0, 0, 0, 0.48));
      }

      .envelope {
        position: absolute;
        inset: 0;
        border-radius: 12px;
        border: 1px solid rgba(255, 255, 255, 0.4);
        overflow: hidden;
        cursor: pointer;
        transform-style: preserve-3d;
        background: linear-gradient(145deg, var(--env-1), var(--env-2));
      }

      .envelope-flap {
        position: absolute;
        left: 0;
        top: 0;
        width: 100%;
        height: 60%;
        clip-path: polygon(0 0, 100% 0, 50% 100%);
        transform-origin: top;
        background: linear-gradient(170deg, #fff1f6, #f6b8ce);
        box-shadow: inset 0 -8px 20px rgba(174, 58, 99, 0.25);
        z-index: 5;
        transition: transform 1100ms cubic-bezier(0.2, 0.8, 0.2, 1);
      }

      .envelope-base {
        position: absolute;
        inset: 0;
        clip-path: polygon(0 0, 50% 52%, 100% 0, 100% 100%, 0 100%);
        background: linear-gradient(160deg, #ffdce8, #f4b8cb);
        z-index: 2;
      }

      .wax {
        position: absolute;
        left: 50%;
        top: 52%;
        width: 52px;
        height: 52px;
        transform: translate(-50%, -50%);
        border-radius: 50%;
        display: grid;
        place-items: center;
        background: radial-gradient(
          circle at 30% 25%,
          #ff6c99,
          #cc1c56 65%,
          #940036
        );
        box-shadow:
          0 0 18px rgba(255, 74, 122, 0.5),
          inset 0 -4px 8px rgba(75, 0, 23, 0.5);
        color: #fff;
        font-size: 19px;
        text-shadow: var(--glow);
        z-index: 7;
        transition: opacity 360ms ease;
      }

      .letter-paper {
        position: absolute;
        left: 50%;
        bottom: 22px;
        width: 90%;
        min-height: 72%;
        transform: translateX(-50%) translateY(78%) scale(0.9);
        border-radius: 12px;
        padding: clamp(16px, 3.8vw, 24px);
        background: linear-gradient(175deg, var(--letter), #ffeef6 86%);
        color: var(--ink);
        box-shadow: 0 10px 25px rgba(136, 12, 54, 0.22);
        z-index: 4;
        overflow: hidden;
        transition: transform 1200ms cubic-bezier(0.2, 0.8, 0.2, 1);
      }

      .letter-paper::before {
        content: "";
        position: absolute;
        inset: 0;
        pointer-events: none;
        background: repeating-linear-gradient(
          180deg,
          rgba(255, 204, 226, 0.12) 0,
          rgba(255, 204, 226, 0.12) 2px,
          transparent 2px,
          transparent 30px
        );
      }

      .letter-content {
        position: relative;
        text-align: center;
        opacity: 0;
        transform: translateY(14px);
        transition:
          opacity 800ms ease 320ms,
          transform 900ms ease 320ms;
      }

      .letter-title {
        margin: 0 0 10px;
        font-size: clamp(1.2rem, 4vw, 1.9rem);
        color: #d91f5b;
        text-shadow: 0 0 12px rgba(255, 80, 131, 0.65);
      }

      .letter-text {
        margin: 0;
        white-space: pre-line;
        line-height: 1.75;
        color: #7f2146;
        font-size: clamp(0.95rem, 3.2vw, 1.1rem);
        text-shadow: 0 0 10px rgba(255, 167, 194, 0.45);
      }

      .hint {
        position: absolute;
        left: 50%;
        bottom: -33px;
        transform: translateX(-50%);
        margin: 0;
        font-size: 0.82rem;
        color: #ffd8e7;
        text-shadow: 0 0 8px rgba(255, 92, 139, 0.52);
        opacity: 0.82;
        pointer-events: none;
      }

      .envelope.open .envelope-flap {
        transform: rotateX(-170deg) translateY(-2px);
      }

      .envelope.open .wax {
        opacity: 0;
      }

      .envelope.open .letter-paper {
        transform: translateX(-50%) translateY(-30%) scale(1);
      }

      .envelope.open .letter-content {
        opacity: 1;
        transform: translateY(0);
      }

      /* floating mini hearts when letter opens */
      .mini-heart {
        position: absolute;
        width: 12px;
        height: 12px;
        transform: rotate(45deg);
        border-radius: 2px;
        background: #ff5f93;
        box-shadow: 0 0 12px rgba(255, 96, 148, 0.92);
        pointer-events: none;
        opacity: 0;
        z-index: 18;
        animation: miniBurst 1900ms ease-out forwards;
      }

      .mini-heart::before,
      .mini-heart::after {
        content: "";
        position: absolute;
        width: 12px;
        height: 12px;
        border-radius: 50%;
        background: inherit;
      }

      .mini-heart::before {
        top: -6px;
        left: 0;
      }

      .mini-heart::after {
        top: 0;
        left: -6px;
      }

      /* ===============================
       Keyframes
    =============================== */
      @keyframes pulse {
        0%,
        100% {
          opacity: 0.45;
        }
        50% {
          opacity: 0.94;
        }
      }

      @keyframes stagePop {
        0% {
          transform: translate(-50%, -50%) scale(0.78);
        }
        60% {
          transform: translate(-50%, -50%) scale(1.03);
        }
        100% {
          transform: translate(-50%, -50%) scale(1);
        }
      }

      @keyframes miniBurst {
        0% {
          opacity: 0;
          transform: translate3d(0, 0, 0) scale(0.2) rotate(45deg);
        }
        16% {
          opacity: 1;
        }
        100% {
          opacity: 0;
          transform: translate3d(var(--tx), var(--ty), 0) scale(1.2)
            rotate(45deg);
        }
      }

      @keyframes grainShift {
        0% {
          transform: translate(0, 0);
        }
        20% {
          transform: translate(-1%, 1%);
        }
        40% {
          transform: translate(1%, -1%);
        }
        60% {
          transform: translate(-1%, -1%);
        }
        80% {
          transform: translate(1%, 1%);
        }
        100% {
          transform: translate(0, 0);
        }
      }

      /* ===============================
       Responsive
    =============================== */
      @media (max-width: 768px) {
        .heart-3d.selected {
          transform: translate3d(calc(50vw - 50%), calc(34vh - 50%), 110px)
            scale(2.2) rotateX(-10deg) rotateY(8deg);
        }

        .letter-stage {
          top: 74%;
        }
      }

      @media (max-width: 420px) {
        .letter-stage {
          width: 92vw;
        }

        .envelope-wrap {
          height: 244px;
        }

        .wax {
          width: 46px;
          height: 46px;
          font-size: 16px;
        }
      }
    </style>
  </head>
  <body>
    <main class="scene" id="scene">
      <canvas id="fxCanvas" aria-hidden="true"></canvas>

      <div class="grain"></div>

      <div class="hud">
        <button
          class="control-btn"
          id="musicToggle"
          type="button"
          aria-pressed="false"
        >
          ♪ Bật nhạc
        </button>
      </div>

      <div class="intro" id="intro">
        <h1>Valentine Cinematic</h1>
        <p>Chạm vào một trái tim để mở quà</p>
      </div>

      <section
        class="heart-field"
        id="heartField"
        aria-label="Floating hearts"
      ></section>

      <section class="letter-stage" id="letterStage" aria-live="polite">
        <div class="envelope-wrap">
          <article
            class="envelope"
            id="envelope"
            role="button"
            tabindex="0"
            aria-label="Open envelope"
          >
            <div class="envelope-flap"></div>
            <div class="envelope-base"></div>
            <div class="wax">❤</div>
            <div class="letter-paper">
              <div class="letter-content">
                <h1 class="letter-title">Happy Valentine's Day ❤️</h1>
                <p class="letter-text">
                  Chúc mừng em Valentine thật xinh đẹp, Luôn rạng rỡ như những
                  đóa hoa mùa xuân,❤️
                </p>
              </div>
            </div>
          </article>
          <p class="hint" id="hintText">Chạm vào phong bì để mở thư</p>
        </div>
      </section>

      <div class="flash" id="flash"></div>
      <div class="vignette"></div>
    </main>

    <audio id="bgm" loop preload="auto">
      <source src="music.mp3" type="audio/mpeg" />
    </audio>

    <script>
      // ===============================
      // DOM refs
      // ===============================
      const scene = document.getElementById("scene");
      const fxCanvas = document.getElementById("fxCanvas");
      const heartField = document.getElementById("heartField");
      const letterStage = document.getElementById("letterStage");
      const envelope = document.getElementById("envelope");
      const hintText = document.getElementById("hintText");
      const flash = document.getElementById("flash");
      const intro = document.getElementById("intro");

      const musicToggle = document.getElementById("musicToggle");
      const bgm = document.getElementById("bgm");

      // ===============================
      // Runtime state
      // ===============================
      const HEART_COUNT = window.innerWidth < 600 ? 24 : 40;
      const hearts = [];
      const particles = [];
      const HEART_PALETTES = [
        { c1: "#ffd5e6", c2: "#ff5b91", c3: "#c8134a", outline: "#ffb8d3" },
        { c1: "#ffe0ec", c2: "#ff6a8d", c3: "#de204f", outline: "#ffc0db" },
        { c1: "#ffd7df", c2: "#ff4f75", c3: "#bf103a", outline: "#ffb3cb" },
        { c1: "#ffd9e8", c2: "#ff527f", c3: "#d3184e", outline: "#ffc6df" },
        { c1: "#ffe3f1", c2: "#ff739f", c3: "#cf2f63", outline: "#ffd0e7" },
      ];

      let dpr = Math.min(window.devicePixelRatio || 1, 2);
      const ctx = fxCanvas.getContext("2d", { alpha: true });

      let selectedHeart = null;
      let letterOpened = false;
      let musicPlaying = false;

      let pointerX = 0;
      let pointerY = 0;
      let pointerTargetX = 0;
      let pointerTargetY = 0;
      let start = performance.now();
      let lastFrame = performance.now();

      // ===============================
      // Canvas particles
      // ===============================
      function resizeCanvas() {
        const w = window.innerWidth;
        const h = window.innerHeight;
        dpr = Math.min(window.devicePixelRatio || 1, 2);
        fxCanvas.width = Math.floor(w * dpr);
        fxCanvas.height = Math.floor(h * dpr);
        fxCanvas.style.width = w + "px";
        fxCanvas.style.height = h + "px";
        ctx.setTransform(dpr, 0, 0, dpr, 0, 0);

        particles.length = 0;
        const count = w < 768 ? 50 : 78;
        for (let i = 0; i < count; i += 1) {
          particles.push(createParticle(w, h));
        }
      }

      function createParticle(w, h) {
        return {
          x: Math.random() * w,
          y: Math.random() * h,
          r: Math.random() * 2 + 0.4,
          phase: Math.random() * Math.PI * 2,
          speed: Math.random() * 0.2 + 0.05,
          sway: (Math.random() - 0.5) * 0.26,
          alpha: Math.random() * 0.45 + 0.2,
        };
      }

      function drawParticles(w, h, t) {
        ctx.clearRect(0, 0, w, h);
        for (const p of particles) {
          p.phase += 0.016;
          p.y -= p.speed;
          p.x += Math.sin(p.phase) * p.sway;

          if (p.y < -8) {
            p.y = h + 8;
            p.x = Math.random() * w;
          }

          const twinkle = 0.55 + Math.sin(p.phase * 1.9 + t * 0.001) * 0.45;
          ctx.beginPath();
          ctx.arc(p.x, p.y, p.r, 0, Math.PI * 2);
          ctx.fillStyle = `rgba(255, ${190 + Math.floor(twinkle * 48)}, ${214 + Math.floor(twinkle * 30)}, ${p.alpha})`;
          ctx.shadowColor = "rgba(255, 120, 162, 0.56)";
          ctx.shadowBlur = 12;
          ctx.fill();
        }
      }

      // ===============================
      // Heart generation + layered upward drift
      // ===============================
      function createHeartEl(index) {
        const el = document.createElement("button");
        el.type = "button";
        el.className = "heart-3d";
        el.setAttribute("aria-label", `Heart ${index + 1}`);

        const isOutline = Math.random() < 0.45;
        const size = isOutline
          ? Math.random() * 30 + 24
          : Math.random() * 42 + 34;
        if (isOutline) el.classList.add("outline");

        const palette =
          HEART_PALETTES[Math.floor(Math.random() * HEART_PALETTES.length)];
        el.style.setProperty("--c1", palette.c1);
        el.style.setProperty("--c2", palette.c2);
        el.style.setProperty("--c3", palette.c3);
        el.style.setProperty("--outline", palette.outline);

        el.style.setProperty("--size", `${size}px`);
        el.innerHTML = `<span class="depth"></span><span class="shape"></span><span class="shine"></span>`;

        const drift = {
          x: Math.random() * window.innerWidth,
          y: Math.random() * (window.innerHeight + size * 2.2) - size * 1.1,
          speed: (isOutline ? 22 : 34) + Math.random() * 34,
          swayAmp: (isOutline ? 10 : 16) + Math.random() * 30,
          swayFreq: 0.6 + Math.random() * 1.2,
          phase: Math.random() * Math.PI * 2,
          zDepth: -90 + Math.random() * 210,
          tiltX: -10 + Math.random() * 20,
          tiltY: -16 + Math.random() * 32,
          roll: -10 + Math.random() * 20,
          yawDrift: 0.7 + Math.random() * 1.4,
          speedWave: 0.8 + Math.random() * 1.6,
          selected: false,
        };

        el.addEventListener("click", () => focusHeart(el, drift));
        heartField.appendChild(el);
        hearts.push({ el, drift, size, isOutline });
      }

      function spawnHearts() {
        hearts.length = 0;
        heartField.innerHTML = "";
        for (let i = 0; i < HEART_COUNT; i += 1) {
          createHeartEl(i);
        }
      }

      function updateHearts(time, dt) {
        const t = (time - start) * 0.001;
        const h = window.innerHeight;
        const w = window.innerWidth;

        for (const heart of hearts) {
          const { drift, el, size, isOutline } = heart;
          if (drift.selected) continue;

          const speedBoost =
            0.82 + Math.sin(t * drift.speedWave + drift.phase) * 0.18;
          drift.y -= drift.speed * speedBoost * dt;
          if (drift.y < -size * 1.8) {
            drift.y = h + size * (0.7 + Math.random() * 1.3);
            drift.x = Math.random() * w;
          }

          const sway =
            Math.sin(t * drift.swayFreq + drift.phase) * drift.swayAmp;
          const x = drift.x + sway + pointerX * (isOutline ? 20 : 34);
          const y = drift.y + pointerY * (isOutline ? 10 : 16);
          const z = drift.zDepth + Math.sin(t * 0.8 + drift.phase) * 24;
          const scale = 0.72 + ((z + 120) / 300) * (isOutline ? 0.34 : 0.46);
          const rx = drift.tiltX + Math.sin(t * 1.3 + drift.phase) * 5;
          const ry =
            drift.tiltY +
            Math.cos(t * 1.1 + drift.phase) * 7 +
            Math.sin(t * drift.yawDrift) * 2;
          const rz = drift.roll + Math.sin(t * 1.5 + drift.phase) * 9;
          const edgeFade = Math.min(
            1,
            Math.max(0.2, (y + size * 2) / (h + size * 2)),
          );
          const depthFade = Math.min(1, Math.max(0.35, 0.6 + z / 260));
          const opacity = edgeFade * depthFade;

          el.style.transform = `translate3d(${x - size / 2}px, ${y - size / 2}px, ${z}px) scale(${scale}) rotateX(${rx}deg) rotateY(${ry}deg) rotateZ(${rz}deg)`;
          el.style.opacity = opacity.toFixed(3);
        }
      }

      // ===============================
      // Camera pan
      // ===============================
      function updateCamera(time) {
        const t = (time - start) * 0.00022;
        const driftX = Math.sin(t) * 10;
        const driftY = Math.cos(t * 1.12) * 6;
        const tx = driftX + pointerX * 7;
        const ty = driftY + pointerY * 5;
        scene.style.transform = `translate3d(${tx}px, ${ty}px, 0) scale(1.02)`;
      }

      function onPointerMove(x, y) {
        pointerTargetX = ((x / window.innerWidth) * 2 - 1) * 0.45;
        pointerTargetY = ((y / window.innerHeight) * 2 - 1) * 0.45;
      }

      // ===============================
      // Interactions
      // ===============================
      function focusHeart(el, drift) {
        if (selectedHeart) return;

        selectedHeart = el;
        drift.selected = true;
        intro.classList.add("hide");

        for (const h of hearts) {
          if (h.el !== el) {
            h.el.style.opacity = "0.17";
            h.el.style.pointerEvents = "none";
          }
        }

        heartField.classList.add("dimmed");
        el.classList.add("selected");

        flash.classList.add("active");
        setTimeout(() => flash.classList.remove("active"), 260);

        setTimeout(() => {
          letterStage.classList.add("visible");
        }, 740);
      }

      function openEnvelope() {
        if (letterOpened || !selectedHeart) return;
        letterOpened = true;
        envelope.classList.add("open");
        hintText.textContent = "Mãi yêu em";
        burstMiniHearts();
        setTimeout(burstMiniHearts, 320);
        tryPlayMusic();
      }

      function burstMiniHearts() {
        const rect = envelope.getBoundingClientRect();
        const count = 12;

        for (let i = 0; i < count; i += 1) {
          const mini = document.createElement("span");
          mini.className = "mini-heart";

          const sx = rect.left + rect.width * (0.42 + Math.random() * 0.16);
          const sy = rect.top + rect.height * 0.28;
          const tx = (Math.random() - 0.5) * 170;
          const ty = -(Math.random() * 140 + 46);

          mini.style.left = `${sx}px`;
          mini.style.top = `${sy}px`;
          mini.style.setProperty("--tx", `${tx}px`);
          mini.style.setProperty("--ty", `${ty}px`);
          mini.style.animationDelay = `${Math.random() * 0.14}s`;

          document.body.appendChild(mini);
          setTimeout(() => mini.remove(), 2100);
        }
      }

      // ===============================
      // Music controls
      // ===============================
      async function tryPlayMusic() {
        if (!bgm) return;
        try {
          bgm.volume = 0.56;
          await bgm.play();
          musicPlaying = true;
          musicToggle.setAttribute("aria-pressed", "true");
          musicToggle.textContent = "♫ Tắt nhạc";
        } catch (_e) {
          musicPlaying = false;
          musicToggle.setAttribute("aria-pressed", "false");
          musicToggle.textContent = "♪ Bật nhạc";
        }
      }

      function stopMusic() {
        if (!bgm) return;
        bgm.pause();
        bgm.currentTime = 0;
        musicPlaying = false;
        musicToggle.setAttribute("aria-pressed", "false");
        musicToggle.textContent = "♪ Bật nhạc";
      }

      // ===============================
      // Main loop
      // ===============================
      function tick(time) {
        const w = window.innerWidth;
        const h = window.innerHeight;
        const dt = Math.min((time - lastFrame) / 1000, 0.04);
        lastFrame = time;
        pointerX += (pointerTargetX - pointerX) * 0.06;
        pointerY += (pointerTargetY - pointerY) * 0.06;
        drawParticles(w, h, time);
        updateHearts(time, dt);
        updateCamera(time);
        requestAnimationFrame(tick);
      }

      // ===============================
      // Events
      // ===============================
      window.addEventListener("resize", () => {
        resizeCanvas();
        spawnHearts();
      });

      window.addEventListener(
        "mousemove",
        (e) => onPointerMove(e.clientX, e.clientY),
        { passive: true },
      );
      window.addEventListener(
        "touchmove",
        (e) => {
          const t = e.touches[0];
          if (!t) return;
          onPointerMove(t.clientX, t.clientY);
        },
        { passive: true },
      );

      envelope.addEventListener("click", openEnvelope);
      envelope.addEventListener("keydown", (e) => {
        if (e.key === "Enter" || e.key === " ") {
          e.preventDefault();
          openEnvelope();
        }
      });

      musicToggle.addEventListener("click", async () => {
        if (musicPlaying) stopMusic();
        else await tryPlayMusic();
      });

      // ===============================
      // Init
      // ===============================
      resizeCanvas();
      spawnHearts();
      requestAnimationFrame(tick);
    </script>
  </body>
</html>
